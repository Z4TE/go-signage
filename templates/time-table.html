{{ define "title" }}index{{ end }}

{{ define "content" }}

    <body  style="overflow-y: auto;">

    <div class="container d-flex text-center">
        <div class="row w-100">
            <div class="col-6 fw-bold fs-1">
                <p style="font-size: 1.6em;">デジタル時刻表</p>
            </div>

            <div class="col-6 text-center text-info fw-bold fs-1">
                <p id="realtime" style="font-size: 1.6em;"></p>
            </div>
        </div>
    </div>
        
    <table class="table table-striped fs-1 text-center" id="timetable">
        <thead>
            <tr>
                <th scope="col" style="width: 25%">出発時刻</th>
                <th scope="col" style="width: 50%">路線名</th>
                <th scope="col" style="width: 25%">行先</th>
            </tr>
        </thead>
        <tbody class="table-group-divider" id="timetable-body">
            {{ range . }}
            <tr>
                <td class="departure-time">{{ .DepartureTime }}</td>
                <td>{{ .RouteID }}</td>
                <td>{{ .Destination }}</td>
            </tr>
            {{ end }}

        </tbody>
    </table>


    <script>
        const timetableBody = document.getElementById('timetable-body');
        const ws = new WebSocket('ws://localhost:8888/ws');

        function renderTimetable(data) {
            timetableBody.innerHTML = '';

            data.forEach((item, index) => {
                const row = timetableBody.insertRow();
                // const remarkCell = row.insertCell();
                const departureTimeCell = row.insertCell();
                const routeIDCell = row.insertCell();
                // const delayCell = row.insertCell();
                const destinationCell = row.insertCell();

                // remarkCell.textContent = item.Remark;
                departureTimeCell.textContent = item.DepartureTime;
                routeIDCell.textContent = item.RouteID;
                destinationCell.textContent = item.Destination;

                if (item.Delay && item.Delay.trim() !== '') {
                    // 遅延がある場合は交互に表示
                    let showingDeparture = true;
                    departureTimeCell.textContent = item.DepartureTime;

                    setInterval(() => {
                        departureTimeCell.textContent = showingDeparture ? item.Delay : item.DepartureTime;
                        showingDeparture = !showingDeparture;
                    }, 3000); // 3秒おきに切り替え
                } else {
                    // 遅延なし：そのまま出発時刻を表示
                    departureTimeCell.textContent = item.DepartureTime;
                }
            });
        }

      

        ws.onmessage = (event) => {
            console.log('Received raw data:', event.data); // 受信した生データを出力
            try {
                const timetableData = JSON.parse(event.data);
                console.log('Parsed data:', timetableData); // パース後のデータを出力
                renderTimetable(timetableData);
                console.log('First item:', timetableData[0]);
            } catch (error) {
                console.error('Error parsing JSON:', error);
            }
        };

        ws.onopen = () => {
            console.log('WebSocket connection opened');
        };

        ws.onclose = () => {
            console.log('WebSocket connection closed');
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        function showClock() {
            let nowTime = new Date();
            let nowHour = nowTime.getHours();
            let nowMin  = nowTime.getMinutes();
            let nowSec  = nowTime.getSeconds();

            // 0埋め
            if (nowHour < 10) {
                nowHour = "0" + nowHour;
            }
            if (nowMin < 10) {
                nowMin = "0" + nowMin;
            }

            let msg = nowHour + ":" + nowMin;
            document.getElementById("realtime").innerHTML = msg;
            }
            setInterval('showClock()',1000);
    </script>
</body>

    
    
{{ end }}
